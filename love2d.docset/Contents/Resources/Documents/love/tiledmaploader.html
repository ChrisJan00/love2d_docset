<html class="client-nojs" dir="ltr" lang="en">
  <head>
    <meta charset="UTF-8"/>
    <title>TiledMapLoader - LOVE</title>
    <meta content="MediaWiki 1.24.2" name="generator"/>
    <link href="" rel="ExportRDF" title="TiledMapLoader" type="application/rdf+xml"/>
    <link href="favicon.ico" rel="shortcut icon"/>
    <link href="opensearch_desc.php" rel="search" title="LOVE (en)" type="application/opensearchdescription+xml"/>
    <link href="api.php_action_rsd" rel="EditURI" type="application/rsd+xml"/>
    <link href="" hreflang="x-default" rel="alternate"/>
    <link href="http://www.gnu.org/copyleft/fdl.html" rel="copyright"/>
    <link href="" rel="alternate" title="LOVE Atom feed" type="application/atom+xml"/>
    <link href="love_wiki_style.css" rel="stylesheet"/>
    <meta content="" name="ResourceLoaderDynamicStyles"/>
    <style>a:lang(ar),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}
/* cache key: love2d_wiki:resourceloader:filter:minify-css:7:daf253d59690fd9cabb6b95510bce103 */</style>
  </head>
  <body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-TiledMapLoader skin-love action-view">
    <div id="globalWrapper">
      <div id="column-content">
        <div class="mw-body" id="content" role="main">
          <h1 class="firstHeading" id="firstHeading" lang="en">TiledMapLoader</h1>
          <div id="bodyContent">
            <div class="mw-content-ltr" dir="ltr" id="mw-content-text" lang="en">
              <p>loader for <a href="http://www.mapeditor.org/" title="Tiled">Tiled</a> (mapeditor) map files.
</p>
              <p>see this forum thread for demo.zip&#xA0;:
<em class="external free" rel="nofollow">http://love2d.org/forums/viewtopic.php?f=5&amp;t=2411&amp;p=25929#p25929</em>
</p>
              <p>note&#xA0;: for an alternative implementation see also 
<em class="external free" rel="nofollow">http://love2d.org/forums/viewtopic.php?f=5&amp;t=2097&amp;hilit=tiled</em>
</p>
              <p>
                <br/>
              </p>
              <div class="mw-geshi mw-code mw-content-ltr" dir="ltr">
                <div class="lua source-lua">
                  <pre class="de1"><span class="co1">-- see https://love2d.org/wiki/TiledMapLoader for latest version</span><span class="co1">-- loader for "tiled" map editor maps (.tmx,xml-based) http://www.mapeditor.org/</span><span class="co1">-- supports multiple layers</span><span class="co1">-- NOTE&#xA0;: function ReplaceMapTileClass (tx,ty,oldTileType,newTileType,fun_callback) end</span><span class="co1">-- NOTE&#xA0;: function TransmuteMap (from_to_table) end -- from_to_table[old]=new</span><span class="co1">-- NOTE&#xA0;: function GetMousePosOnMap () return gMouseX+gCamX-gScreenW/2,gMouseY+gCamY-gScreenH/2 end</span>
&#xA0;
kTileSize <span class="sy0">=</span> <span class="nu0">32</span>
kMapTileTypeEmpty <span class="sy0">=</span> <span class="nu0">0</span>
<span class="kw1">local</span> <span class="kw3">floor</span> <span class="sy0">=</span> <span class="kw3">math.floor</span>
<span class="kw1">local</span> <span class="kw3">ceil</span> <span class="sy0">=</span> <span class="kw3">math.ceil</span>
<span class="kw1">local</span> <span class="kw3">max</span> <span class="sy0">=</span> <span class="kw3">math.max</span>
<span class="kw1">local</span> <span class="kw3">min</span> <span class="sy0">=</span> <span class="kw3">math.min</span>
<span class="kw1">local</span> <span class="kw3">abs</span> <span class="sy0">=</span> <span class="kw3">math.abs</span>
gTileMap_LayerInvisByName <span class="sy0">=</span> <span class="br0">{</span><span class="br0">}</span>
&#xA0;
<span class="kw1">function</span> TiledMap_Load <span class="br0">(</span>filepath<span class="sy0">,</span>tilesize<span class="sy0">,</span>spritepath_removeold<span class="sy0">,</span>spritepath_prefix<span class="br0">)</span>
    spritepath_removeold <span class="sy0">=</span> spritepath_removeold <span class="kw2">or</span> <span class="st0">"../"</span>
    spritepath_prefix <span class="sy0">=</span> spritepath_prefix <span class="kw2">or</span> <span class="st0">""</span>
    kTileSize <span class="sy0">=</span> tilesize <span class="kw2">or</span> kTileSize <span class="kw2">or</span> <span class="nu0">32</span>
    gTileGfx <span class="sy0">=</span> <span class="br0">{</span><span class="br0">}</span>
&#xA0;
    <span class="kw1">local</span> tiletype<span class="sy0">,</span>layers <span class="sy0">=</span> TiledMap_Parse<span class="br0">(</span>filepath<span class="br0">)</span>
    gMapLayers <span class="sy0">=</span> layers
    <span class="kw1">for</span> first_gid<span class="sy0">,</span>path <span class="kw2">in</span> <span class="kw3">pairs</span><span class="br0">(</span>tiletype<span class="br0">)</span> <span class="kw1">do</span>
        path <span class="sy0">=</span> spritepath_prefix <span class="sy0">..</span> <span class="kw3">string.gsub</span><span class="br0">(</span>path<span class="sy0">,</span><span class="st0">"^"</span><span class="sy0">..</span><span class="kw3">string.gsub</span><span class="br0">(</span>spritepath_removeold<span class="sy0">,</span><span class="st0">"%."</span><span class="sy0">,</span><span class="st0">"%%."</span><span class="br0">)</span><span class="sy0">,</span><span class="st0">""</span><span class="br0">)</span>
        <span class="kw1">local</span> raw <span class="sy0">=</span> love<span class="sy0">.</span>image<span class="sy0">.</span>newImageData<span class="br0">(</span>path<span class="br0">)</span>
        <span class="kw1">local</span> w<span class="sy0">,</span>h <span class="sy0">=</span> raw<span class="sy0">:</span>getWidth<span class="br0">(</span><span class="br0">)</span><span class="sy0">,</span>raw<span class="sy0">:</span>getHeight<span class="br0">(</span><span class="br0">)</span>
        <span class="kw1">local</span> gid <span class="sy0">=</span> first_gid
        <span class="kw1">local</span> e <span class="sy0">=</span> kTileSize
        <span class="kw1">for</span> y<span class="sy0">=</span><span class="nu0">0</span><span class="sy0">,</span><span class="kw3">floor</span><span class="br0">(</span>h<span class="sy0">/</span>kTileSize<span class="br0">)</span><span class="sy0">-</span><span class="nu0">1</span> <span class="kw1">do</span>
        <span class="kw1">for</span> x<span class="sy0">=</span><span class="nu0">0</span><span class="sy0">,</span><span class="kw3">floor</span><span class="br0">(</span>w<span class="sy0">/</span>kTileSize<span class="br0">)</span><span class="sy0">-</span><span class="nu0">1</span> <span class="kw1">do</span>
            <span class="kw1">local</span> sprite <span class="sy0">=</span> love<span class="sy0">.</span>image<span class="sy0">.</span>newImageData<span class="br0">(</span>kTileSize<span class="sy0">,</span>kTileSize<span class="br0">)</span>
            sprite<span class="sy0">:</span>paste<span class="br0">(</span>raw<span class="sy0">,</span><span class="nu0">0</span><span class="sy0">,</span><span class="nu0">0</span><span class="sy0">,</span>x<span class="sy0">*</span>e<span class="sy0">,</span>y<span class="sy0">*</span>e<span class="sy0">,</span>e<span class="sy0">,</span>e<span class="br0">)</span>
            gTileGfx<span class="br0">[</span>gid<span class="br0">]</span> <span class="sy0">=</span> love<span class="sy0">.</span>graphics<span class="sy0">.</span>newImage<span class="br0">(</span>sprite<span class="br0">)</span>
            gid <span class="sy0">=</span> gid <span class="sy0">+</span> <span class="nu0">1</span>
        <span class="kw1">end</span>
        <span class="kw1">end</span>
    <span class="kw1">end</span>
<span class="kw1">end</span>
&#xA0;
<span class="kw1">function</span> TiledMap_GetMapW <span class="br0">(</span><span class="br0">)</span> <span class="kw1">return</span> gMapLayers<span class="sy0">.</span>width <span class="kw1">end</span>
<span class="kw1">function</span> TiledMap_GetMapH <span class="br0">(</span><span class="br0">)</span> <span class="kw1">return</span> gMapLayers<span class="sy0">.</span>height <span class="kw1">end</span>
&#xA0;
<span class="co1">-- returns the mapwidth actually used by tiles</span>
<span class="kw1">function</span> TiledMap_GetMapWUsed <span class="br0">(</span><span class="br0">)</span>
	<span class="kw1">local</span> maxx <span class="sy0">=</span> <span class="nu0">0</span>
	<span class="kw1">local</span> miny <span class="sy0">=</span> <span class="nu0">0</span>
	<span class="kw1">local</span> maxy <span class="sy0">=</span> <span class="nu0">0</span>
	<span class="kw1">for</span> layerid<span class="sy0">,</span>layer <span class="kw2">in</span> <span class="kw3">pairs</span><span class="br0">(</span>gMapLayers<span class="br0">)</span> <span class="kw1">do</span> 
		<span class="kw1">if</span> <span class="br0">(</span><span class="kw3">type</span><span class="br0">(</span>layer<span class="br0">)</span> <span class="sy0">==</span> <span class="st0">"table"</span><span class="br0">)</span> <span class="kw1">then</span> <span class="kw1">for</span> ty<span class="sy0">,</span>row <span class="kw2">in</span> <span class="kw3">pairs</span><span class="br0">(</span>layer<span class="br0">)</span> <span class="kw1">do</span>
			<span class="kw1">if</span> <span class="br0">(</span><span class="kw3">type</span><span class="br0">(</span>row<span class="br0">)</span> <span class="sy0">==</span> <span class="st0">"table"</span><span class="br0">)</span> <span class="kw1">then</span> <span class="kw1">for</span> tx<span class="sy0">,</span>t <span class="kw2">in</span> <span class="kw3">pairs</span><span class="br0">(</span>row<span class="br0">)</span> <span class="kw1">do</span> 
				<span class="kw1">if</span> <span class="br0">(</span>t <span class="kw2">and</span> t <span class="sy0">~=</span> kMapTileTypeEmpty<span class="br0">)</span> <span class="kw1">then</span> 
					miny <span class="sy0">=</span> <span class="kw3">min</span><span class="br0">(</span>miny<span class="sy0">,</span>ty<span class="br0">)</span>
					maxy <span class="sy0">=</span> <span class="kw3">max</span><span class="br0">(</span>maxy<span class="sy0">,</span>ty<span class="br0">)</span>
					maxx <span class="sy0">=</span> <span class="kw3">max</span><span class="br0">(</span>maxx<span class="sy0">,</span>tx<span class="br0">)</span>
				<span class="kw1">end</span>
			<span class="kw1">end</span> <span class="kw1">end</span>
		<span class="kw1">end</span> <span class="kw1">end</span>
	<span class="kw1">end</span>
	<span class="kw1">return</span> maxx <span class="sy0">+</span> <span class="nu0">1</span><span class="sy0">,</span>miny<span class="sy0">,</span>maxy<span class="sy0">+</span><span class="nu0">1</span>
<span class="kw1">end</span>
&#xA0;
<span class="co1">-- x,y= position for nearest-distance(square,not round), z= layer, maxrad= optional limit for searching</span>
<span class="co1">-- returns x,y</span>
<span class="co1">-- if x,y can be far outside map, set a sensible maxrad, otherwise it'll get very slow since searching outside map isn't optimized</span>
<span class="kw1">function</span> TiledMap_GetNearestTileByTypeOnLayer <span class="br0">(</span>x<span class="sy0">,</span>y<span class="sy0">,</span>z<span class="sy0">,</span>iTileType<span class="sy0">,</span>maxrad<span class="br0">)</span>
	<span class="kw1">local</span> w <span class="sy0">=</span> TiledMap_GetMapW<span class="br0">(</span><span class="br0">)</span>
	<span class="kw1">local</span> h <span class="sy0">=</span> TiledMap_GetMapW<span class="br0">(</span><span class="br0">)</span>
	<span class="kw1">local</span> maxrad2 <span class="sy0">=</span> <span class="kw3">max</span><span class="br0">(</span>x<span class="sy0">,</span>w<span class="sy0">-</span>x<span class="sy0">,</span>y<span class="sy0">,</span>h<span class="sy0">-</span>y<span class="br0">)</span> <span class="kw1">if</span> <span class="br0">(</span>maxrad<span class="br0">)</span> <span class="kw1">then</span> maxrad2 <span class="sy0">=</span> <span class="kw3">min</span><span class="br0">(</span>maxrad2<span class="sy0">,</span>maxrad<span class="br0">)</span> <span class="kw1">end</span>
	<span class="kw1">if</span> <span class="br0">(</span>TiledMap_GetMapTile<span class="br0">(</span>x<span class="sy0">,</span>y<span class="sy0">,</span>z<span class="br0">)</span> <span class="sy0">==</span> iTileType<span class="br0">)</span> <span class="kw1">then</span> <span class="kw1">return</span> x<span class="sy0">,</span>y <span class="kw1">end</span>
	<span class="kw1">for</span> r <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">,</span>maxrad2 <span class="kw1">do</span> 
		<span class="kw1">for</span> i<span class="sy0">=-</span>r<span class="sy0">,</span>r <span class="kw1">do</span> 
			<span class="kw1">local</span> xa<span class="sy0">,</span>ya <span class="sy0">=</span> x<span class="sy0">+</span>i<span class="sy0">,</span>y<span class="sy0">-</span>r <span class="kw1">if</span> <span class="br0">(</span>TiledMap_GetMapTile<span class="br0">(</span>xa<span class="sy0">,</span>ya<span class="sy0">,</span>z<span class="br0">)</span> <span class="sy0">==</span> iTileType<span class="br0">)</span> <span class="kw1">then</span> <span class="kw1">return</span> xa<span class="sy0">,</span>ya <span class="kw1">end</span> <span class="co1">-- top</span>
			<span class="kw1">local</span> xa<span class="sy0">,</span>ya <span class="sy0">=</span> x<span class="sy0">+</span>i<span class="sy0">,</span>y<span class="sy0">+</span>r <span class="kw1">if</span> <span class="br0">(</span>TiledMap_GetMapTile<span class="br0">(</span>xa<span class="sy0">,</span>ya<span class="sy0">,</span>z<span class="br0">)</span> <span class="sy0">==</span> iTileType<span class="br0">)</span> <span class="kw1">then</span> <span class="kw1">return</span> xa<span class="sy0">,</span>ya <span class="kw1">end</span> <span class="co1">-- bot</span>
			<span class="kw1">local</span> xa<span class="sy0">,</span>ya <span class="sy0">=</span> x<span class="sy0">-</span>r<span class="sy0">,</span>y<span class="sy0">+</span>i <span class="kw1">if</span> <span class="br0">(</span>TiledMap_GetMapTile<span class="br0">(</span>xa<span class="sy0">,</span>ya<span class="sy0">,</span>z<span class="br0">)</span> <span class="sy0">==</span> iTileType<span class="br0">)</span> <span class="kw1">then</span> <span class="kw1">return</span> xa<span class="sy0">,</span>ya <span class="kw1">end</span> <span class="co1">-- left</span>
			<span class="kw1">local</span> xa<span class="sy0">,</span>ya <span class="sy0">=</span> x<span class="sy0">+</span>r<span class="sy0">,</span>y<span class="sy0">+</span>i <span class="kw1">if</span> <span class="br0">(</span>TiledMap_GetMapTile<span class="br0">(</span>xa<span class="sy0">,</span>ya<span class="sy0">,</span>z<span class="br0">)</span> <span class="sy0">==</span> iTileType<span class="br0">)</span> <span class="kw1">then</span> <span class="kw1">return</span> xa<span class="sy0">,</span>ya <span class="kw1">end</span> <span class="co1">-- right</span>
		<span class="kw1">end</span>
	<span class="kw1">end</span>
<span class="kw1">end</span>
&#xA0;
<span class="kw1">function</span> TiledMap_GetMapTile <span class="br0">(</span>tx<span class="sy0">,</span>ty<span class="sy0">,</span>layerid<span class="br0">)</span> <span class="co1">-- coords in tiles</span>
    <span class="kw1">local</span> row <span class="sy0">=</span> gMapLayers<span class="br0">[</span>layerid<span class="br0">]</span><span class="br0">[</span>ty<span class="br0">]</span>
    <span class="kw1">return</span> row <span class="kw2">and</span> row<span class="br0">[</span>tx<span class="br0">]</span> <span class="kw2">or</span> kMapTileTypeEmpty
<span class="kw1">end</span>
&#xA0;
<span class="kw1">function</span> TiledMap_SetMapTile <span class="br0">(</span>tx<span class="sy0">,</span>ty<span class="sy0">,</span>layerid<span class="sy0">,</span>v<span class="br0">)</span> <span class="co1">-- coords in tiles</span>
    <span class="kw1">local</span> row <span class="sy0">=</span> gMapLayers<span class="br0">[</span>layerid<span class="br0">]</span><span class="br0">[</span>ty<span class="br0">]</span>
	<span class="kw1">if</span> <span class="br0">(</span><span class="kw2">not</span> row<span class="br0">)</span> <span class="kw1">then</span> row <span class="sy0">=</span> <span class="br0">{</span><span class="br0">}</span> gMapLayers<span class="br0">[</span>layerid<span class="br0">]</span><span class="br0">[</span>ty<span class="br0">]</span> <span class="sy0">=</span> row <span class="kw1">end</span>
	row<span class="br0">[</span>tx<span class="br0">]</span> <span class="sy0">=</span> v
<span class="kw1">end</span>
&#xA0;
<span class="co1">-- todo&#xA0;: maybe optimize during parse xml for types registered as to-be-listed before parsing&#xA0;?</span>
<span class="kw1">function</span> TiledMap_ListAllOfTypeOnLayer <span class="br0">(</span>layerid<span class="sy0">,</span>iTileType<span class="br0">)</span>
	<span class="kw1">local</span> res <span class="sy0">=</span> <span class="br0">{</span><span class="br0">}</span>
	<span class="kw1">local</span> w <span class="sy0">=</span> TiledMap_GetMapW<span class="br0">(</span><span class="br0">)</span>
	<span class="kw1">local</span> h <span class="sy0">=</span> TiledMap_GetMapH<span class="br0">(</span><span class="br0">)</span>
	<span class="kw1">for</span> x<span class="sy0">=</span><span class="nu0">0</span><span class="sy0">,</span>w<span class="sy0">-</span><span class="nu0">1</span> <span class="kw1">do</span> 
	<span class="kw1">for</span> y<span class="sy0">=</span><span class="nu0">0</span><span class="sy0">,</span>h<span class="sy0">-</span><span class="nu0">1</span> <span class="kw1">do</span> 
		<span class="kw1">if</span> <span class="br0">(</span>TiledMap_GetMapTile<span class="br0">(</span>x<span class="sy0">,</span>y<span class="sy0">,</span>layerid<span class="br0">)</span> <span class="sy0">==</span> iTileType<span class="br0">)</span> <span class="kw1">then</span> <span class="kw3">table.insert</span><span class="br0">(</span>res<span class="sy0">,</span><span class="br0">{</span>x<span class="sy0">=</span>x<span class="sy0">,</span>y<span class="sy0">=</span>y<span class="br0">}</span><span class="br0">)</span> <span class="kw1">end</span>
	<span class="kw1">end</span>
	<span class="kw1">end</span>
	<span class="kw1">return</span> res
<span class="kw1">end</span>
&#xA0;
<span class="kw1">function</span> TiledMap_GetLayerZByName <span class="br0">(</span>layername<span class="br0">)</span> <span class="kw1">for</span> z<span class="sy0">,</span>layer <span class="kw2">in</span> <span class="kw3">ipairs</span><span class="br0">(</span>gMapLayers<span class="br0">)</span> <span class="kw1">do</span> <span class="kw1">if</span> <span class="br0">(</span>layer<span class="sy0">.</span>name <span class="sy0">==</span> layername<span class="br0">)</span> <span class="kw1">then</span> <span class="kw1">return</span> z <span class="kw1">end</span> <span class="kw1">end</span> <span class="kw1">end</span>
<span class="kw1">function</span> TiledMap_SetLayerInvisByName <span class="br0">(</span>layername<span class="br0">)</span> gTileMap_LayerInvisByName<span class="br0">[</span>layername<span class="br0">]</span> <span class="sy0">=</span> <span class="kw4">true</span> <span class="kw1">end</span>
&#xA0;
<span class="kw1">function</span> TiledMap_IsLayerVisible <span class="br0">(</span>z<span class="br0">)</span>
	<span class="kw1">local</span> layer <span class="sy0">=</span> gMapLayers<span class="br0">[</span>z<span class="br0">]</span>
	<span class="kw1">return</span> layer <span class="kw2">and</span> <span class="br0">(</span><span class="kw2">not</span> gTileMap_LayerInvisByName<span class="br0">[</span>layer<span class="sy0">.</span>name <span class="kw2">or</span> <span class="st0">"?"</span><span class="br0">]</span><span class="br0">)</span>
<span class="kw1">end</span>
&#xA0;
<span class="kw1">function</span> TiledMap_GetTilePosUnderMouse <span class="br0">(</span>mx<span class="sy0">,</span>my<span class="sy0">,</span>camx<span class="sy0">,</span>camy<span class="br0">)</span>
	<span class="kw1">return</span>	<span class="kw3">floor</span><span class="br0">(</span><span class="br0">(</span>mx<span class="sy0">+</span>camx<span class="sy0">-</span>love<span class="sy0">.</span>graphics<span class="sy0">.</span>getWidth<span class="br0">(</span><span class="br0">)</span><span class="sy0">/</span><span class="nu0">2</span><span class="br0">)</span><span class="sy0">/</span>kTileSize<span class="br0">)</span><span class="sy0">,</span>
			<span class="kw3">floor</span><span class="br0">(</span><span class="br0">(</span>my<span class="sy0">+</span>camy<span class="sy0">-</span>love<span class="sy0">.</span>graphics<span class="sy0">.</span>getHeight<span class="br0">(</span><span class="br0">)</span><span class="sy0">/</span><span class="nu0">2</span><span class="br0">)</span><span class="sy0">/</span>kTileSize<span class="br0">)</span>
<span class="kw1">end</span>
&#xA0;
<span class="kw1">function</span> TiledMap_DrawNearCam <span class="br0">(</span>camx<span class="sy0">,</span>camy<span class="sy0">,</span>fun_layercallback<span class="br0">)</span>
    camx<span class="sy0">,</span>camy <span class="sy0">=</span> <span class="kw3">floor</span><span class="br0">(</span>camx<span class="br0">)</span><span class="sy0">,</span><span class="kw3">floor</span><span class="br0">(</span>camy<span class="br0">)</span>
    <span class="kw1">local</span> screen_w <span class="sy0">=</span> love<span class="sy0">.</span>graphics<span class="sy0">.</span>getWidth<span class="br0">(</span><span class="br0">)</span>
    <span class="kw1">local</span> screen_h <span class="sy0">=</span> love<span class="sy0">.</span>graphics<span class="sy0">.</span>getHeight<span class="br0">(</span><span class="br0">)</span>
    <span class="kw1">local</span> minx<span class="sy0">,</span>maxx <span class="sy0">=</span> <span class="kw3">floor</span><span class="br0">(</span><span class="br0">(</span>camx<span class="sy0">-</span>screen_w<span class="sy0">/</span><span class="nu0">2</span><span class="br0">)</span><span class="sy0">/</span>kTileSize<span class="br0">)</span><span class="sy0">,</span><span class="kw3">ceil</span><span class="br0">(</span><span class="br0">(</span>camx<span class="sy0">+</span>screen_w<span class="sy0">/</span><span class="nu0">2</span><span class="br0">)</span><span class="sy0">/</span>kTileSize<span class="br0">)</span>
    <span class="kw1">local</span> miny<span class="sy0">,</span>maxy <span class="sy0">=</span> <span class="kw3">floor</span><span class="br0">(</span><span class="br0">(</span>camy<span class="sy0">-</span>screen_h<span class="sy0">/</span><span class="nu0">2</span><span class="br0">)</span><span class="sy0">/</span>kTileSize<span class="br0">)</span><span class="sy0">,</span><span class="kw3">ceil</span><span class="br0">(</span><span class="br0">(</span>camy<span class="sy0">+</span>screen_h<span class="sy0">/</span><span class="nu0">2</span><span class="br0">)</span><span class="sy0">/</span>kTileSize<span class="br0">)</span>
    <span class="kw1">for</span> z <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">,#</span>gMapLayers <span class="kw1">do</span> 
	<span class="kw1">if</span> <span class="br0">(</span>fun_layercallback<span class="br0">)</span> <span class="kw1">then</span> fun_layercallback<span class="br0">(</span>z<span class="sy0">,</span>gMapLayers<span class="br0">[</span>z<span class="br0">]</span><span class="br0">)</span> <span class="kw1">end</span>
	<span class="kw1">if</span> <span class="br0">(</span>TiledMap_IsLayerVisible<span class="br0">(</span>z<span class="br0">)</span><span class="br0">)</span> <span class="kw1">then</span>
    <span class="kw1">for</span> x <span class="sy0">=</span> minx<span class="sy0">,</span>maxx <span class="kw1">do</span>
    <span class="kw1">for</span> y <span class="sy0">=</span> miny<span class="sy0">,</span>maxy <span class="kw1">do</span>
        <span class="kw1">local</span> gfx <span class="sy0">=</span> gTileGfx<span class="br0">[</span>TiledMap_GetMapTile<span class="br0">(</span>x<span class="sy0">,</span>y<span class="sy0">,</span>z<span class="br0">)</span><span class="br0">]</span>
        <span class="kw1">if</span> <span class="br0">(</span>gfx<span class="br0">)</span> <span class="kw1">then</span>
            <span class="kw1">local</span> sx <span class="sy0">=</span> x<span class="sy0">*</span>kTileSize <span class="sy0">-</span> camx <span class="sy0">+</span> screen_w<span class="sy0">/</span><span class="nu0">2</span>
            <span class="kw1">local</span> sy <span class="sy0">=</span> y<span class="sy0">*</span>kTileSize <span class="sy0">-</span> camy <span class="sy0">+</span> screen_h<span class="sy0">/</span><span class="nu0">2</span>
            love<span class="sy0">.</span>graphics<span class="sy0">.</span>draw<span class="br0">(</span>gfx<span class="sy0">,</span>sx<span class="sy0">,</span>sy<span class="br0">)</span> <span class="co1">-- x, y, r, sx, sy, ox, oy</span>
        <span class="kw1">end</span>
    <span class="kw1">end</span>
    <span class="kw1">end</span>
    <span class="kw1">end</span>
    <span class="kw1">end</span>
<span class="kw1">end</span>
&#xA0;
&#xA0;
<span class="co1">-- ***** ***** ***** ***** ***** xml parser</span>
&#xA0;
&#xA0;
<span class="co1">-- LoadXML from http://lua-users.org/wiki/LuaXml</span>
<span class="kw1">function</span> LoadXML<span class="br0">(</span>s<span class="br0">)</span>
  <span class="kw1">local</span> <span class="kw1">function</span> LoadXML_parseargs<span class="br0">(</span>s<span class="br0">)</span>
    <span class="kw1">local</span> arg <span class="sy0">=</span> <span class="br0">{</span><span class="br0">}</span>
    <span class="kw3">string.gsub</span><span class="br0">(</span>s<span class="sy0">,</span> <span class="st0">"(%w+)=([<span class="es1">\"</span>'])(.-)%2"</span><span class="sy0">,</span> <span class="kw1">function</span> <span class="br0">(</span>w<span class="sy0">,</span> _<span class="sy0">,</span> a<span class="br0">)</span>
    arg<span class="br0">[</span>w<span class="br0">]</span> <span class="sy0">=</span> a
    <span class="kw1">end</span><span class="br0">)</span>
    <span class="kw1">return</span> arg
  <span class="kw1">end</span>
  <span class="kw1">local</span> stack <span class="sy0">=</span> <span class="br0">{</span><span class="br0">}</span>
  <span class="kw1">local</span> top <span class="sy0">=</span> <span class="br0">{</span><span class="br0">}</span>
  <span class="kw3">table.insert</span><span class="br0">(</span>stack<span class="sy0">,</span> top<span class="br0">)</span>
  <span class="kw1">local</span> ni<span class="sy0">,</span>c<span class="sy0">,</span>label<span class="sy0">,</span>xarg<span class="sy0">,</span> empty
  <span class="kw1">local</span> i<span class="sy0">,</span> j <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">,</span> <span class="nu0">1</span>
  <span class="kw1">while</span> <span class="kw4">true</span> <span class="kw1">do</span>
    ni<span class="sy0">,</span>j<span class="sy0">,</span>c<span class="sy0">,</span>label<span class="sy0">,</span>xarg<span class="sy0">,</span> empty <span class="sy0">=</span> <span class="kw3">string.find</span><span class="br0">(</span>s<span class="sy0">,</span> <span class="st0">"&lt;(%/?)([%w:]+)(.-)(%/?)&gt;"</span><span class="sy0">,</span> i<span class="br0">)</span>
    <span class="kw1">if</span> <span class="kw2">not</span> ni <span class="kw1">then</span> <span class="kw1">break</span> <span class="kw1">end</span>
    <span class="kw1">local</span> text <span class="sy0">=</span> <span class="kw3">string.sub</span><span class="br0">(</span>s<span class="sy0">,</span> i<span class="sy0">,</span> ni<span class="sy0">-</span><span class="nu0">1</span><span class="br0">)</span>
    <span class="kw1">if</span> <span class="kw2">not</span> <span class="kw3">string.find</span><span class="br0">(</span>text<span class="sy0">,</span> <span class="st0">"^%s*$"</span><span class="br0">)</span> <span class="kw1">then</span>
      <span class="kw3">table.insert</span><span class="br0">(</span>top<span class="sy0">,</span> text<span class="br0">)</span>
    <span class="kw1">end</span>
    <span class="kw1">if</span> empty <span class="sy0">==</span> <span class="st0">"/"</span> <span class="kw1">then</span>  <span class="co1">-- empty element tag</span>
      <span class="kw3">table.insert</span><span class="br0">(</span>top<span class="sy0">,</span> <span class="br0">{</span>label<span class="sy0">=</span>label<span class="sy0">,</span> xarg<span class="sy0">=</span>LoadXML_parseargs<span class="br0">(</span>xarg<span class="br0">)</span><span class="sy0">,</span> empty<span class="sy0">=</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">)</span>
    <span class="kw1">elseif</span> c <span class="sy0">==</span> <span class="st0">""</span> <span class="kw1">then</span>   <span class="co1">-- start tag</span>
      top <span class="sy0">=</span> <span class="br0">{</span>label<span class="sy0">=</span>label<span class="sy0">,</span> xarg<span class="sy0">=</span>LoadXML_parseargs<span class="br0">(</span>xarg<span class="br0">)</span><span class="br0">}</span>
      <span class="kw3">table.insert</span><span class="br0">(</span>stack<span class="sy0">,</span> top<span class="br0">)</span>   <span class="co1">-- new level</span>
    <span class="kw1">else</span>  <span class="co1">-- end tag</span>
      <span class="kw1">local</span> toclose <span class="sy0">=</span> <span class="kw3">table.remove</span><span class="br0">(</span>stack<span class="br0">)</span>  <span class="co1">-- remove top</span>
      top <span class="sy0">=</span> stack<span class="br0">[</span><span class="sy0">#</span>stack<span class="br0">]</span>
      <span class="kw1">if</span> <span class="sy0">#</span>stack <span class="sy0">&lt;</span> <span class="nu0">1</span> <span class="kw1">then</span>
        <span class="kw3">error</span><span class="br0">(</span><span class="st0">"nothing to close with "</span><span class="sy0">..</span>label<span class="br0">)</span>
      <span class="kw1">end</span>
      <span class="kw1">if</span> toclose<span class="sy0">.</span>label <span class="sy0">~=</span> label <span class="kw1">then</span>
        <span class="kw3">error</span><span class="br0">(</span><span class="st0">"trying to close "</span><span class="sy0">..</span>toclose<span class="sy0">.</span>label<span class="sy0">..</span><span class="st0">" with "</span><span class="sy0">..</span>label<span class="br0">)</span>
      <span class="kw1">end</span>
      <span class="kw3">table.insert</span><span class="br0">(</span>top<span class="sy0">,</span> toclose<span class="br0">)</span>
    <span class="kw1">end</span>
    i <span class="sy0">=</span> j<span class="sy0">+</span><span class="nu0">1</span>
  <span class="kw1">end</span>
  <span class="kw1">local</span> text <span class="sy0">=</span> <span class="kw3">string.sub</span><span class="br0">(</span>s<span class="sy0">,</span> i<span class="br0">)</span>
  <span class="kw1">if</span> <span class="kw2">not</span> <span class="kw3">string.find</span><span class="br0">(</span>text<span class="sy0">,</span> <span class="st0">"^%s*$"</span><span class="br0">)</span> <span class="kw1">then</span>
    <span class="kw3">table.insert</span><span class="br0">(</span>stack<span class="br0">[</span><span class="sy0">#</span>stack<span class="br0">]</span><span class="sy0">,</span> text<span class="br0">)</span>
  <span class="kw1">end</span>
  <span class="kw1">if</span> <span class="sy0">#</span>stack <span class="sy0">&gt;</span> <span class="nu0">1</span> <span class="kw1">then</span>
    <span class="kw3">error</span><span class="br0">(</span><span class="st0">"unclosed "</span><span class="sy0">..</span>stack<span class="br0">[</span>stack<span class="sy0">.</span>n<span class="br0">]</span><span class="sy0">.</span>label<span class="br0">)</span>
  <span class="kw1">end</span>
  <span class="kw1">return</span> stack<span class="br0">[</span><span class="nu0">1</span><span class="br0">]</span>
<span class="kw1">end</span>
&#xA0;
&#xA0;
<span class="co1">-- ***** ***** ***** ***** ***** parsing the tilemap xml file</span>
&#xA0;
<span class="kw1">local</span> <span class="kw1">function</span> getTilesets<span class="br0">(</span>node<span class="br0">)</span>
    <span class="kw1">local</span> tiles <span class="sy0">=</span> <span class="br0">{</span><span class="br0">}</span>
    <span class="kw1">for</span> k<span class="sy0">,</span> sub <span class="kw2">in</span> <span class="kw3">ipairs</span><span class="br0">(</span>node<span class="br0">)</span> <span class="kw1">do</span>
        <span class="kw1">if</span> <span class="br0">(</span>sub<span class="sy0">.</span>label <span class="sy0">==</span> <span class="st0">"tileset"</span><span class="br0">)</span> <span class="kw1">then</span>
            tiles<span class="br0">[</span><span class="kw3">tonumber</span><span class="br0">(</span>sub<span class="sy0">.</span>xarg<span class="sy0">.</span>firstgid<span class="br0">)</span><span class="br0">]</span> <span class="sy0">=</span> sub<span class="br0">[</span><span class="nu0">1</span><span class="br0">]</span><span class="sy0">.</span>xarg<span class="sy0">.</span>source
        <span class="kw1">end</span>
    <span class="kw1">end</span>
    <span class="kw1">return</span> tiles
<span class="kw1">end</span>
&#xA0;
<span class="kw1">local</span> <span class="kw1">function</span> getLayers<span class="br0">(</span>node<span class="br0">)</span>
    <span class="kw1">local</span> layers <span class="sy0">=</span> <span class="br0">{</span><span class="br0">}</span>
	layers<span class="sy0">.</span>width <span class="sy0">=</span> <span class="nu0">0</span>
	layers<span class="sy0">.</span>height <span class="sy0">=</span> <span class="nu0">0</span>
    <span class="kw1">for</span> k<span class="sy0">,</span> sub <span class="kw2">in</span> <span class="kw3">ipairs</span><span class="br0">(</span>node<span class="br0">)</span> <span class="kw1">do</span>
        <span class="kw1">if</span> <span class="br0">(</span>sub<span class="sy0">.</span>label <span class="sy0">==</span> <span class="st0">"layer"</span><span class="br0">)</span> <span class="kw1">then</span> <span class="co1">--  and sub.xarg.name == layer_name</span>
			layers<span class="sy0">.</span>width  <span class="sy0">=</span> <span class="kw3">max</span><span class="br0">(</span>layers<span class="sy0">.</span>width <span class="sy0">,</span><span class="kw3">tonumber</span><span class="br0">(</span>sub<span class="sy0">.</span>xarg<span class="sy0">.</span>width <span class="br0">)</span> <span class="kw2">or</span> <span class="nu0">0</span><span class="br0">)</span>
			layers<span class="sy0">.</span>height <span class="sy0">=</span> <span class="kw3">max</span><span class="br0">(</span>layers<span class="sy0">.</span>height<span class="sy0">,</span><span class="kw3">tonumber</span><span class="br0">(</span>sub<span class="sy0">.</span>xarg<span class="sy0">.</span>height<span class="br0">)</span> <span class="kw2">or</span> <span class="nu0">0</span><span class="br0">)</span>
            <span class="kw1">local</span> layer <span class="sy0">=</span> <span class="br0">{</span><span class="br0">}</span>
            <span class="kw3">table.insert</span><span class="br0">(</span>layers<span class="sy0">,</span>layer<span class="br0">)</span>
			layer<span class="sy0">.</span>name <span class="sy0">=</span> sub<span class="sy0">.</span>xarg<span class="sy0">.</span>name
			<span class="co1">--~ print("layername",layer.name)</span>
            width <span class="sy0">=</span> <span class="kw3">tonumber</span><span class="br0">(</span>sub<span class="sy0">.</span>xarg<span class="sy0">.</span>width<span class="br0">)</span>
            i <span class="sy0">=</span> <span class="nu0">0</span>
            j <span class="sy0">=</span> <span class="nu0">0</span>
            <span class="kw1">for</span> l<span class="sy0">,</span> child <span class="kw2">in</span> <span class="kw3">ipairs</span><span class="br0">(</span>sub<span class="br0">[</span><span class="nu0">1</span><span class="br0">]</span><span class="br0">)</span> <span class="kw1">do</span>
                <span class="kw1">if</span> <span class="br0">(</span>j <span class="sy0">==</span> <span class="nu0">0</span><span class="br0">)</span> <span class="kw1">then</span>
                    layer<span class="br0">[</span>i<span class="br0">]</span> <span class="sy0">=</span> <span class="br0">{</span><span class="br0">}</span>
                <span class="kw1">end</span>
                layer<span class="br0">[</span>i<span class="br0">]</span><span class="br0">[</span>j<span class="br0">]</span> <span class="sy0">=</span> <span class="kw3">tonumber</span><span class="br0">(</span>child<span class="sy0">.</span>xarg<span class="sy0">.</span>gid<span class="br0">)</span>
                j <span class="sy0">=</span> j <span class="sy0">+</span> <span class="nu0">1</span>
                <span class="kw1">if</span> j <span class="sy0">&gt;=</span> width <span class="kw1">then</span>
                    j <span class="sy0">=</span> <span class="nu0">0</span>
                    i <span class="sy0">=</span> i <span class="sy0">+</span> <span class="nu0">1</span>
                <span class="kw1">end</span>
            <span class="kw1">end</span>
        <span class="kw1">end</span>
    <span class="kw1">end</span>
    <span class="kw1">return</span> layers
<span class="kw1">end</span>
&#xA0;
<span class="kw1">function</span> TiledMap_Parse<span class="br0">(</span>filename<span class="br0">)</span>
    <span class="kw1">local</span> xml <span class="sy0">=</span> LoadXML<span class="br0">(</span>love<span class="sy0">.</span>filesystem<span class="sy0">.</span><span class="kw3">read</span><span class="br0">(</span>filename<span class="br0">)</span><span class="br0">)</span>
    <span class="kw1">local</span> tiles <span class="sy0">=</span> getTilesets<span class="br0">(</span>xml<span class="br0">[</span><span class="nu0">2</span><span class="br0">]</span><span class="br0">)</span>
    <span class="kw1">local</span> layers <span class="sy0">=</span> getLayers<span class="br0">(</span>xml<span class="br0">[</span><span class="nu0">2</span><span class="br0">]</span><span class="br0">)</span>
    <span class="kw1">return</span> tiles<span class="sy0">,</span> layers
<span class="kw1">end</span></pre>
                </div>
              </div>
              <h2>
                <span class="mw-headline" id="usage_demo">usage demo</span>
              </h2>
              <p>(see zip file in forum for map files and graphics)
</p>
              <div class="mw-geshi mw-code mw-content-ltr" dir="ltr">
                <div class="lua source-lua">
                  <pre class="de1"><span class="co1">-- small demo for TiledMap loader</span>
love<span class="sy0">.</span>filesystem<span class="sy0">.</span>load<span class="br0">(</span><span class="st0">"tiledmap.lua"</span><span class="br0">)</span><span class="br0">(</span><span class="br0">)</span>
&#xA0;
gKeyPressed <span class="sy0">=</span> <span class="br0">{</span><span class="br0">}</span>
gCamX<span class="sy0">,</span>gCamY <span class="sy0">=</span> <span class="nu0">100</span><span class="sy0">,</span><span class="nu0">100</span>
&#xA0;
<span class="kw1">function</span> love<span class="sy0">.</span>load<span class="br0">(</span><span class="br0">)</span>
	TiledMap_Load<span class="br0">(</span><span class="st0">"map/map01.tmx"</span><span class="br0">)</span>
<span class="kw1">end</span>
&#xA0;
<span class="kw1">function</span> love<span class="sy0">.</span>keyreleased<span class="br0">(</span> key <span class="br0">)</span>
	gKeyPressed<span class="br0">[</span>key<span class="br0">]</span> <span class="sy0">=</span> <span class="kw4">nil</span>
<span class="kw1">end</span>
&#xA0;
<span class="kw1">function</span> love<span class="sy0">.</span>keypressed<span class="br0">(</span> key<span class="sy0">,</span> unicode <span class="br0">)</span> 
	gKeyPressed<span class="br0">[</span>key<span class="br0">]</span> <span class="sy0">=</span> <span class="kw4">true</span> 
	<span class="kw1">if</span> <span class="br0">(</span>key <span class="sy0">==</span> <span class="st0">"escape"</span><span class="br0">)</span> <span class="kw1">then</span> <span class="kw3">os.exit</span><span class="br0">(</span><span class="nu0">0</span><span class="br0">)</span> <span class="kw1">end</span>
	<span class="kw1">if</span> <span class="br0">(</span>key <span class="sy0">==</span> <span class="st0">" "</span><span class="br0">)</span> <span class="kw1">then</span> <span class="co1">-- space = next mal</span>
		gMapNum <span class="sy0">=</span> <span class="br0">(</span>gMapNum <span class="kw2">or</span> <span class="nu0">1</span><span class="br0">)</span> <span class="sy0">+</span> <span class="nu0">1</span>
		<span class="kw1">if</span> <span class="br0">(</span>gMapNum <span class="sy0">&gt;</span> <span class="nu0">10</span><span class="br0">)</span> <span class="kw1">then</span> gMapNum <span class="sy0">=</span> <span class="nu0">1</span> <span class="kw1">end</span>
		TiledMap_Load<span class="br0">(</span><span class="kw3">string.format</span><span class="br0">(</span><span class="st0">"map/map%02d.tmx"</span><span class="sy0">,</span>gMapNum<span class="br0">)</span><span class="br0">)</span>
		gCamX<span class="sy0">,</span>gCamY <span class="sy0">=</span> <span class="nu0">100</span><span class="sy0">,</span><span class="nu0">100</span>
	<span class="kw1">end</span>
<span class="kw1">end</span>
&#xA0;
<span class="kw1">function</span> love<span class="sy0">.</span>update<span class="br0">(</span> dt <span class="br0">)</span>
	<span class="kw1">local</span> s <span class="sy0">=</span> <span class="nu0">500</span><span class="sy0">*</span>dt
	<span class="kw1">if</span> <span class="br0">(</span>gKeyPressed<span class="sy0">.</span>up<span class="br0">)</span> <span class="kw1">then</span> gCamY <span class="sy0">=</span> gCamY <span class="sy0">-</span> s <span class="kw1">end</span>
	<span class="kw1">if</span> <span class="br0">(</span>gKeyPressed<span class="sy0">.</span>down<span class="br0">)</span> <span class="kw1">then</span> gCamY <span class="sy0">=</span> gCamY <span class="sy0">+</span> s <span class="kw1">end</span>
	<span class="kw1">if</span> <span class="br0">(</span>gKeyPressed<span class="sy0">.</span>left<span class="br0">)</span> <span class="kw1">then</span> gCamX <span class="sy0">=</span> gCamX <span class="sy0">-</span> s <span class="kw1">end</span>
	<span class="kw1">if</span> <span class="br0">(</span>gKeyPressed<span class="sy0">.</span>right<span class="br0">)</span> <span class="kw1">then</span> gCamX <span class="sy0">=</span> gCamX <span class="sy0">+</span> s <span class="kw1">end</span>
<span class="kw1">end</span>
&#xA0;
<span class="kw1">function</span> love<span class="sy0">.</span>draw<span class="br0">(</span><span class="br0">)</span>
    love<span class="sy0">.</span>graphics<span class="sy0">.</span><span class="kw3">print</span><span class="br0">(</span><span class="st0">'arrow-keys=scroll, space=next map'</span><span class="sy0">,</span> <span class="nu0">50</span><span class="sy0">,</span> <span class="nu0">50</span><span class="br0">)</span>
	love<span class="sy0">.</span>graphics<span class="sy0">.</span>setBackgroundColor<span class="br0">(</span><span class="nu0">0x80</span><span class="sy0">,</span><span class="nu0">0x80</span><span class="sy0">,</span><span class="nu0">0x80</span><span class="br0">)</span>
	TiledMap_DrawNearCam<span class="br0">(</span>gCamX<span class="sy0">,</span>gCamY<span class="br0">)</span>
<span class="kw1">end</span></pre>
                </div>
              </div>
            </div>
            <div class="catlinks" id="catlinks">
              <div class="mw-normal-catlinks" id="mw-normal-catlinks"><em>Category</em>: <ul><li><a href="category_snippets.html" title="Category:Snippets">Snippets</a></li></ul></div>
            </div>
            <div class="visualClear"/>
          </div>
        </div>
      </div>
      <div class="visualClear"/>
      <div id="footer" role="contentinfo">
        <ul id="f-list">
          <li id="copyright">Content is available under <a class="external" href="http://www.gnu.org/copyleft/fdl.html" rel="nofollow">GNU Free Documentation License 1.3</a> unless otherwise noted.</li>
        </ul>
      </div>
    </div>
  </body>
</html>
